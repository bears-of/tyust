# Token 验证功能实现检查清单

## 📋 快速验证清单

使用此清单快速验证 Token 验证和自动登录功能是否正常工作。

---

## ✅ 文件检查

### 新增文件
- [ ] `utils/auth.js` - Token 管理工具（187行）
- [ ] `utils/pageAuth.js` - 页面认证检查工具（121行）
- [ ] `TOKEN_AUTH_README.md` - 功能说明
- [ ] `TOKEN_AUTH_GUIDE.md` - 使用指南
- [ ] `TOKEN_TEST_GUIDE.md` - 测试指南
- [ ] `TOKEN_IMPLEMENTATION_SUMMARY.md` - 实现总结
- [ ] `CHECKLIST.md` - 本文件

### 修改文件
- [ ] `utils/request.js` - 优化 Token 失效处理
- [ ] `pages/login/index.js` - 添加登录状态检查
- [ ] `pages/mine/index.js` - 优化用户中心
- [ ] `pages/score/index.js` - 添加认证检查
- [ ] `pages/course/index.js` - 添加认证检查

---

## ✅ 功能验证

### 1. 基础功能
- [ ] 正常登录可以成功
- [ ] 登录后 Token 正确保存
- [ ] 登录后用户信息正确保存
- [ ] 退出登录可以清除认证信息
- [ ] 退出登录保留账号密码（如果勾选记住）

### 2. Token 失效处理
- [ ] 手动设置无效 Token 后访问接口会自动跳转
- [ ] 跳转前显示"登录已失效"提示
- [ ] 跳转到登录页
- [ ] 本地认证信息被清除
- [ ] 账号密码被保留

### 3. 登录状态检查
- [ ] 未登录访问成绩页自动跳转登录页
- [ ] 未登录访问课程页自动跳转登录页
- [ ] 已登录访问登录页自动跳转首页
- [ ] 个人中心正确显示登录/未登录状态

### 4. 防重复跳转
- [ ] 多个请求同时失效只跳转一次
- [ ] 不会出现多个提示框
- [ ] 跳转流畅不卡顿

### 5. 记住密码功能
- [ ] 勾选"记住密码"后退出再进入账号自动填充
- [ ] 不勾选"记住密码"后退出再进入账号为空

---

## ✅ 代码质量检查

### 代码规范
- [ ] 所有文件使用统一的代码风格
- [ ] 变量命名清晰易懂
- [ ] 函数职责单一
- [ ] 有必要的注释说明

### 错误处理
- [ ] 所有 Promise 都有 catch 处理
- [ ] 网络错误有友好提示
- [ ] 不会导致程序崩溃

### 性能
- [ ] Token 检查性能良好（< 5ms）
- [ ] 没有不必要的同步操作
- [ ] 没有内存泄漏

---

## ✅ 用户体验检查

### 提示信息
- [ ] 提示文字清晰易懂
- [ ] 提示时机恰当
- [ ] 提示时长合适（1.5-2秒）

### 页面跳转
- [ ] 跳转流畅不突兀
- [ ] 使用 wx.reLaunch 避免返回栈问题
- [ ] 跳转前有适当延迟让用户看到提示

### 加载状态
- [ ] 登录时显示"登录中..."
- [ ] 数据加载时显示"正在加载"
- [ ] 加载完成后正确隐藏

---

## ✅ 兼容性检查

### 微信版本
- [ ] 微信开发者工具正常
- [ ] iOS 微信正常
- [ ] Android 微信正常

### 不同场景
- [ ] 首次安装正常
- [ ] 升级后正常
- [ ] 清除缓存后正常

---

## ✅ 测试场景验证

### 场景 1：首次使用
```
操作：首次打开小程序
预期：跳转到登录页
实际：□ 通过 □ 失败
```

### 场景 2：正常登录
```
操作：输入账号密码，点击登录
预期：显示"登录成功"，跳转首页
实际：□ 通过 □ 失败
```

### 场景 3：Token 失效
```
操作：设置无效Token，刷新成绩
代码：wx.setStorageSync('token', 'invalid')
预期：显示"登录已失效"，跳转登录页
实际：□ 通过 □ 失败
```

### 场景 4：未登录访问
```
操作：清除Token，访问成绩页
代码：wx.removeStorageSync('token')
预期：显示"请先登录"，跳转登录页
实际：□ 通过 □ 失败
```

### 场景 5：已登录访问登录页
```
操作：登录后，尝试访问登录页
预期：显示"您已登录"，跳转首页
实际：□ 通过 □ 失败
```

### 场景 6：退出登录
```
操作：点击退出登录，确认
预期：清除数据，跳转登录页，账号密码保留
实际：□ 通过 □ 失败
```

### 场景 7：记住密码
```
操作：勾选记住密码登录，退出，重新进入
预期：账号密码自动填充
实际：□ 通过 □ 失败
```

### 场景 8：网络错误
```
操作：断网后点击登录
预期：显示"网络请求失败"
实际：□ 通过 □ 失败
```

---

## ✅ 控制台验证

### 检查 Token
```javascript
console.log('Token:', wx.getStorageSync('token'))
// 预期：登录后有值，退出后为空
```

### 检查用户信息
```javascript
const auth = require('../../utils/auth')
console.log('用户信息:', auth.getUserInfo())
// 预期：包含 studentId, name, class, avatarUrl
```

### 检查登录状态
```javascript
const auth = require('../../utils/auth')
console.log('是否登录:', auth.hasToken())
// 预期：登录后为 true，退出后为 false
```

### 模拟 Token 失效
```javascript
// 设置无效Token
wx.setStorageSync('token', 'invalid_token_123')
// 然后刷新任意需要认证的页面
// 预期：自动跳转到登录页
```

---

## ✅ 文档检查

- [ ] README 文档完整清晰
- [ ] 使用指南详细易懂
- [ ] 测试指南覆盖全面
- [ ] 代码示例可以直接使用
- [ ] 没有错别字和格式问题

---

## ✅ 安全检查

- [ ] Token 不在代码中硬编码
- [ ] Token 失效立即清除
- [ ] 敏感信息不在控制台打印
- [ ] 请求头正确携带 Token

---

## ✅ 部署检查

### 开发环境
- [ ] 开发者工具运行正常
- [ ] 控制台无错误日志
- [ ] 网络请求正常

### 测试环境
- [ ] 真机调试正常
- [ ] iOS 设备正常
- [ ] Android 设备正常

### 生产环境
- [ ] 已备份原代码
- [ ] 已通过所有测试
- [ ] 已更新版本号
- [ ] 已准备回滚方案

---

## 🐛 常见问题检查

### 问题 1：Token 失效后没有跳转
- [ ] 检查后端返回 code 是否为 401 或 403
- [ ] 检查 request.js 中的状态码判断
- [ ] 查看控制台错误日志

### 问题 2：重复跳转登录页
- [ ] 检查 isHandlingTokenExpired 标志位
- [ ] 确认使用 wx.reLaunch 而非 wx.redirectTo
- [ ] 检查是否有多处跳转逻辑

### 问题 3：账号密码没有保留
- [ ] 检查是否调用 auth.clearAuth(true)
- [ ] 确认 STORAGE_KEYS.ACCOUNT 未被清除
- [ ] 检查登录页 initAccount 方法

### 问题 4：页面白屏或卡死
- [ ] 检查是否有死循环
- [ ] 检查是否有阻塞操作
- [ ] 使用性能分析工具排查

---

## 📊 性能指标

### 响应时间
- [ ] Token 检查 < 5ms
- [ ] 登录请求 < 2s
- [ ] 页面跳转 < 500ms

### 内存使用
- [ ] 无明显内存泄漏
- [ ] 内存占用在合理范围

### 用户体验
- [ ] 操作流畅不卡顿
- [ ] 提示信息及时准确
- [ ] 没有异常闪烁

---

## ✅ 最终确认

- [ ] 所有功能测试通过
- [ ] 所有文档检查通过
- [ ] 代码质量符合标准
- [ ] 用户体验良好
- [ ] 性能指标达标
- [ ] 安全检查通过
- [ ] 准备好部署到生产环境

---

## 📝 备注

### 完成日期
__________

### 测试人员
__________

### 发现的问题
1. __________
2. __________

### 待优化项
1. __________
2. __________

### 其他说明
__________

---

## 🎉 完成标志

当以上所有项目都打勾 ✅ 时，表示 Token 验证功能已完整实现并测试通过！
