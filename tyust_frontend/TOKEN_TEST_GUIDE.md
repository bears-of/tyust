# Token 验证功能测试指南

本文档提供 Token 验证和自动登录功能的完整测试流程。

## 测试环境准备

### 1. 开发工具
- 微信开发者工具
- 清除所有缓存数据
- 确保后端服务正常运行

### 2. 测试账号
准备至少 2 个测试账号：
- 账号A：用于正常登录测试
- 账号B：用于切换账号测试

## 测试场景

### 场景1：正常登录流程

**测试步骤：**
1. 打开小程序，应该自动跳转到登录页
2. 输入学号和密码
3. 勾选"记住密码"
4. 点击登录

**预期结果：**
- ✅ 显示"登录中..."加载提示
- ✅ 登录成功后显示"登录成功"提示
- ✅ 自动跳转到首页（课程表）
- ✅ Token 和用户信息保存到本地存储

**验证方法：**
```javascript
// 在控制台执行
console.log('Token:', wx.getStorageSync('token'))
console.log('StudentId:', wx.getStorageSync('studentId'))
console.log('Name:', wx.getStorageSync('name'))
```

---

### 场景2：已登录状态访问登录页

**测试步骤：**
1. 确保已登录
2. 尝试访问登录页：`/pages/login/index`

**预期结果：**
- ✅ 显示"您已登录"提示
- ✅ 自动跳转回首页
- ✅ 不会停留在登录页

---

### 场景3：未登录访问需要认证的页面

**测试步骤：**
1. 退出登录（清除 Token）
2. 尝试访问成绩页面或课程表

**预期结果：**
- ✅ 显示"请先登录"提示
- ✅ 自动跳转到登录页
- ✅ 页面内容不会加载

**清除 Token 方法：**
```javascript
// 在控制台执行
wx.removeStorageSync('token')
```

---

### 场景4：Token 失效自动重新登录

**测试步骤：**
1. 正常登录
2. 手动将 Token 改为无效值
3. 访问任意需要认证的接口（如刷新成绩）

**预期结果：**
- ✅ 接口返回 401 或 403 状态码
- ✅ 显示"登录已失效，请重新登录"提示
- ✅ 自动清除本地认证信息
- ✅ 2秒后自动跳转到登录页
- ✅ 如果之前勾选了"记住密码"，账号密码应该保留

**模拟 Token 失效：**
```javascript
// 在控制台执行
wx.setStorageSync('token', 'invalid_token_123456')
```

---

### 场景5：多个请求同时失效

**测试步骤：**
1. 正常登录
2. 将 Token 改为无效值
3. 快速触发多个需要认证的请求（如同时刷新成绩和课程）

**预期结果：**
- ✅ 只显示一次"登录已失效"提示
- ✅ 只跳转一次登录页（不会重复跳转）
- ✅ 所有请求都被正确拦截

---

### 场景6：记住密码功能

**测试步骤：**
1. 登录时勾选"记住密码"
2. 退出登录
3. 重新进入登录页

**预期结果：**
- ✅ 学号和密码自动填充
- ✅ "记住密码"复选框处于勾选状态

**测试步骤（不记住）：**
1. 登录时不勾选"记住密码"
2. 退出登录
3. 重新进入登录页

**预期结果：**
- ✅ 学号和密码为空
- ✅ "记住密码"复选框未勾选

---

### 场景7：退出登录

**测试步骤：**
1. 正常登录
2. 进入个人中心
3. 点击"退出登录"
4. 在弹窗中点击"确定"

**预期结果：**
- ✅ 显示确认弹窗
- ✅ 显示"已退出登录"提示
- ✅ 本地认证信息被清除（Token、studentId、name、class 等）
- ✅ 账号密码保留（如果之前勾选了记住）
- ✅ 1.5秒后跳转到登录页

**验证数据清除：**
```javascript
// 在控制台执行
console.log('Token:', wx.getStorageSync('token')) // 应为空
console.log('Account:', wx.getStorageSync('account')) // 应保留
```

---

### 场景8：个人中心未登录状态

**测试步骤：**
1. 清除 Token
2. 进入个人中心（tabBar 页面）

**预期结果：**
- ✅ 显示未登录状态的 UI
- ✅ 显示"去登录"按钮
- ✅ 点击按钮可跳转到登录页
- ✅ 不会自动跳转（因为 tabBar 页面）

---

### 场景9：网络请求错误处理

**测试步骤：**
1. 断开网络连接
2. 尝试登录或刷新数据

**预期结果：**
- ✅ 显示"网络请求失败"提示
- ✅ 不会跳转到登录页
- ✅ 加载状态正确隐藏

---

### 场景10：后端返回不同的错误码

**测试场景：**
```javascript
// 场景 A: code = 0 (成功)
{ code: 0, data: {...}, msg: 'success' }
// 预期：正常处理数据

// 场景 B: code = -1 (业务错误)
{ code: -1, msg: '成绩数据不存在' }
// 预期：显示错误提示，不跳转登录页

// 场景 C: code = 401 (未认证)
{ code: 401, msg: 'Token已失效' }
// 预期：清除认证信息，跳转登录页

// 场景 D: code = 403 (无权限)
{ code: 403, msg: '无权访问' }
// 预期：清除认证信息，跳转登录页
```

---

## 性能测试

### 测试1：Token 检查性能
**测试方法：**
```javascript
console.time('checkToken')
const auth = require('../../utils/auth')
auth.hasToken()
console.timeEnd('checkToken')
```

**预期结果：**
- ✅ 检查时间 < 5ms

### 测试2：大量并发请求
**测试方法：**
发起 10 个并发请求，模拟 Token 失效

**预期结果：**
- ✅ 只触发一次跳转
- ✅ 所有请求都被正确拦截
- ✅ 无内存泄漏

---

## 边界测试

### 测试1：空 Token
```javascript
wx.setStorageSync('token', '')
// 预期：被识别为未登录
```

### 测试2：特殊字符 Token
```javascript
wx.setStorageSync('token', '!@#$%^&*()')
// 预期：正常发送到后端，由后端验证
```

### 测试3：超长 Token
```javascript
wx.setStorageSync('token', 'a'.repeat(10000))
// 预期：正常处理，不崩溃
```

### 测试4：存储空间满
模拟存储空间满的情况

**预期结果：**
- ✅ 显示友好的错误提示
- ✅ 不会导致程序崩溃

---

## 兼容性测试

### 测试不同微信版本
- iOS 微信 8.0+
- Android 微信 8.0+
- 开发者工具

### 测试不同机型
- iPhone 12 Pro
- 华为 P40
- 小米 11

---

## 自动化测试脚本

### 快速清除认证信息
```javascript
// 在控制台执行
function clearAuth() {
  wx.removeStorageSync('token')
  wx.removeStorageSync('studentId')
  wx.removeStorageSync('name')
  wx.removeStorageSync('class')
  console.log('认证信息已清除')
}
clearAuth()
```

### 快速设置无效 Token
```javascript
// 在控制台执行
function setInvalidToken() {
  wx.setStorageSync('token', 'invalid_token_' + Date.now())
  console.log('已设置无效Token')
}
setInvalidToken()
```

### 快速验证登录状态
```javascript
// 在控制台执行
function checkLoginStatus() {
  const auth = require('../../utils/auth')
  console.log('是否有Token:', auth.hasToken())
  console.log('Token:', auth.getToken())
  console.log('用户信息:', auth.getUserInfo())
}
checkLoginStatus()
```

---

## 测试检查清单

### 功能测试
- [ ] 正常登录流程
- [ ] 已登录访问登录页自动跳转
- [ ] 未登录访问需认证页面自动跳转
- [ ] Token 失效自动重新登录
- [ ] 多个请求同时失效不重复跳转
- [ ] 记住密码功能
- [ ] 退出登录功能
- [ ] 个人中心未登录状态展示

### 异常测试
- [ ] 网络断开
- [ ] 后端服务不可用
- [ ] 返回错误的状态码
- [ ] Token 为空/无效

### 性能测试
- [ ] Token 检查性能 < 5ms
- [ ] 大量并发请求不卡顿
- [ ] 无内存泄漏

### 兼容性测试
- [ ] iOS 设备正常
- [ ] Android 设备正常
- [ ] 开发者工具正常

### 用户体验测试
- [ ] 提示信息友好清晰
- [ ] 跳转流畅不卡顿
- [ ] 加载状态显示正确
- [ ] 没有多余的弹窗

---

## 常见问题排查

### 问题1：Token 失效后没有跳转
**排查步骤：**
1. 检查后端返回的 code 是否为 401 或 403
2. 检查 `request.js` 中的状态码判断逻辑
3. 查看控制台是否有错误日志

### 问题2：重复跳转登录页
**排查步骤：**
1. 检查 `isHandlingTokenExpired` 标志位是否正常工作
2. 检查是否使用了 `wx.reLaunch` 而不是 `wx.redirectTo`
3. 检查是否有多处调用跳转逻辑

### 问题3：账号密码没有保留
**排查步骤：**
1. 检查退出登录时是否调用了 `auth.clearAuth(true)`
2. 检查 `STORAGE_KEYS.ACCOUNT` 是否被清除
3. 检查登录页的 `initAccount` 方法

### 问题4：页面加载慢
**排查步骤：**
1. 检查是否有不必要的同步操作
2. 检查网络请求是否设置了合理的超时时间
3. 使用性能分析工具检查瓶颈

---

## 测试报告模板

```
# Token 验证功能测试报告

## 测试信息
- 测试人员：___________
- 测试时间：___________
- 测试环境：___________
- 微信版本：___________

## 测试结果
| 测试场景 | 预期结果 | 实际结果 | 是否通过 | 备注 |
|---------|---------|---------|---------|------|
| 正常登录 | 跳转首页 | 跳转首页 | ✅ | - |
| Token失效 | 跳转登录页 | 跳转登录页 | ✅ | - |
| ... | ... | ... | ... | ... |

## 发现的问题
1. ___________
2. ___________

## 优化建议
1. ___________
2. ___________

## 总结
___________
```

---

## 持续集成建议

### 自动化测试脚本
建议使用微信小程序自动化测试框架进行持续集成测试。

### 监控指标
- Token 失效率
- 自动跳转成功率
- 用户重新登录率
- 接口错误率

### 告警设置
- Token 失效频率过高
- 自动跳转失败
- 用户投诉增加

---

## 参考文档

- [TOKEN_AUTH_README.md](./TOKEN_AUTH_README.md) - 功能说明
- [TOKEN_AUTH_GUIDE.md](./TOKEN_AUTH_GUIDE.md) - 使用指南
- 微信小程序官方文档